<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Return of the Clustering</title>

		<link rel="stylesheet" href="css/reveal.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
    <link rel="stylesheet" href="css/theme/long-ago-faraway.css">

	</head>
	<body>
		<div class="reveal">
			<div class="slides">
        <section>
          <h1>Return <small>of the</small> Clustering</h1>
          <p>Kubernetes for Drupal</p>
          <small><br/>use &larr;&uarr;&darr;&rarr; or &lt;space&gt;</small>
        </section>

        <section>
          <h2>"Where's the links?"</h2>
          <p><a href="https://socketwench.github.io/return-of-the-clustering">socketwench.github.io/return-of-the-clustering</a></p>
        </section>

        <section>
          <section data-transition="none" data-background-transition="none" data-background="images/socketwench1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/socketwench2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/socketwench3.png" data-background-size="contain">
            &nbsp;
          </section>
					<section data-transition="none" data-background-transition="none" data-background="images/socketwench4.png" data-background-size="contain">
            &nbsp;
          </section>
					<section data-transition="none" data-background-transition="none" data-background="images/socketwench5.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background="images/t7-background.jpg" class="teamten7">
            <img src="images/TEN7-logo.png" />
            <p class="fragment">We create and care for<br />Drupal-powered websites.</p>
            <p class="fragment">Minneapolis, MN <span class="fragment">(Mostly!)</span></p>
          </section>
          <section data-background="images/t7-background.jpg" class="teamten7">
            <h2 class="ten7">Services</h2>
            <p class="fragment">Site and hosting migratiton</p>
            <p class="fragment">Drupal 8 upgrades</p>
            <p class="fragment">Site audits</p>
            <p class="fragment">Process consultantcy</p>
          </section>
          <section data-background="images/t7-background.jpg" class="teamten7">
            <img src="images/TEN7-logo.png" />
            <p><a href="https://twitter.com/TEN7">@TEN7</a><br /><a href="mailto:hi@ten7.com">hi@ten7.com</a></p>
          </section>

          <section  data-transition="none" data-background-transition="none" data-background="images/trilogy1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/trilogy2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/trilogy3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/trilogy4.png" data-background-size="contain">
            <a href="https://www.youtube.com/watch?v=mQSQH8tT9bA">
              <h2>Ride the Whale</h2>
              <p>Docker for Drupalists</p>
            </a>
            <a href="https://www.youtube.com/watch?v=2K4B48hrYfE" class="fragment">
              <h2>Avoid Deep Hurting!</h2>
              <p>Deployments beyond git</p>
            </a>
          </section>
        </section>

        <section>
          <section data-transition="none">
            <img src="images/dockerInProd1.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd2.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd3.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd4.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd5.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd6.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd7.png" />
          </section>
          <section>
            <h1>Docker in Production?</h1>
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard4.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard5.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard6.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard7.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/dockersecurity1.png" data-background-size="contain">
            <h2>Docker Security</h2>
            <p class="fragment">Docker maps users between host and container</p>
            <p class="fragment">Most containers run...<span class="fragment">as root</span></p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/dockersecurity2.png" data-background-size="contain">
            <h2>Docker Security</h2>
            <p>Docker maps users between host and container</p>
            <p>Most containers run...<span>as root</span></p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/dockersecurity3.png" data-background-size="contain">
            <h2>Docker Security</h2>
            <p>Docker maps users between host and container</p>
            <p>Most containers run...<span>as root</span></p>
          </section>
          <section>
            <h2>Passing config</h2>
            <p class="fragment">Avoid Compose-style environment variables</p>
            <p class="fragment">Use <a href="https://docs.docker.com/engine/swarm/secrets/">Secrets</a>, <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">Config Maps</a> instead</p>
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts01.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts02.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts03.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts04.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts05.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts06.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts07.png" />
          </section>
          <section>
            <h2>Single-node Docker</h2>
            <p class="fragment">Runs all containers on the same system</p>
            <p class="fragment">Easy, but scaling is vertical only</p>
          </section>
          <section>
            <h2>orchestration</h2>
            <p class="fragment">Coordinates hosts to act as one</p>
            <p class="fragment">Deploy instances, distribute load, deliver resources</p>
          </section>
          <section>
            <h2>Swarm mode</h2>
            <p class="fragment">Docker's own orchestrator</p>
            <p class="fragment">Built-in, free to use</p>
          </section>
          <section data-transition="none">
            <img src="images/swarm01.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm02.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm03.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm04.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm05.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm06.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm07.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm08.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm09.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm10.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm11.png" />
          </section>
          <section>
            <h2>Lack of hosting choice</h2>
            <p class="fragment">Docker cloud was expensive <span class="fragment">(and discontinued)</span></p>
            <p class="fragment">Self-host, sort out LB and storage</p>
          </section>
          <section>
            <h2>Too "uncontrolled"</h2>
            <p class="fragment">Containers only managable unit</p>
            <p class="fragment">Internal LB creates Drupal problems</a>
          </section>
        </section>
        <section>
          <section data-transition="none">
            <img src="images/whatsThis1.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThis2.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThis3.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThis4.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThis5.png" />
          </section>
          <section>
            <h1>Koo-ber-WHAT-ees?</h1>
          </section>
          <section>
            <h2>Kubernetes</h2>
            <p class="fragment">Open-source container orchestrator</p>
            <p class="fragment">Created by Google, maintained by <a href="https://www.cncf.io/">CNCF</a></a>
          </section>
          <section>
            <h2>Expressive Power</h2>
            <p class="fragment"><em>Pods</em> only one of many managable objects</p>
            <p class="fragment">Tailor k8s to your app, not the other way around</p>
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical1.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical2.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical3.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical4.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical5.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical6.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical7.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical8.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical9.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical1.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical2.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical3.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical4.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical5.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical6.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical7.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical8.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical9.png" />
          </section>
          <section>
            <h2>Deployments</h2>
            <p class="fragment">Describes an application</p>
            <p class="fragment">Not just what containers to use</p>
            <p class="fragment">Replicas, health checks, placement</p>
          </section>
          <section>
            <h2>Services</h2>
            <p class="fragment">A consistent application endpoint</p>
            <p class="fragment">Internal, external, load-balanced</p>
          </section>
          <section>
            <h2>volume Claim (pvc)</h2>
            <p class="fragment">A request for persistent storage</p>
            <p class="fragment">How much, from where, sharability</p>
          </section>
          <section>
            <h2>Deploying objects</h2>
            <p class="fragment">Declaritive YAML pushed to manager</p>
            <p class="fragment">YAML can be patched, diffed, even replaced</p>
          </section>
          <section data-transition="none" data-background-transition="fade" data-background="images/this-much-devops.jpg" data-background-size="contain">
            &nbsp;
          </section>
        </section>

        <section>
          <section data-transition="none">
            <img src="images/hosting1.png" />
          </section>
          <section data-transition="none">
            <img src="images/hosting2.png" />
          </section>
          <section data-transition="none">
            <img src="images/hosting3.png" />
          </section>
          <section data-transition="none">
            <img src="images/hosting4.png" />
          </section>
          <section data-background="images/speeder.png" data-background-size="contain">
            <h1>Getting to Kube-y station</h1>
          </section>
          <section>
            <h2>Self-host</h2>
            <p class="fragment">Internal on existing hardware...</p>
            <p class="fragment">...or 3rd-party VPS service</p>
          </section>
          <section>
            <h2>Less lock-in</h2>
            <p class="fragment">No reliance on special APIs</p>
            <p class="fragment">Requires staff to manage cluster, set up storage</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/installK8s1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/installK8s2.png" data-background-size="contain">
            <p>Install Docker, kubelet</p>
            <p class="fragment">Install kubeadm, kubectl on manager</p>
            <p class="fragment">Install <a href="https://www.projectcalico.org/">Calico CNI</a></p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/installK8s3.png" data-background-size="contain">
            <p>Install Docker, kubelet</p>
            <p>Install kubeadm, kubectl on manager</p>
            <p>Install <a href="https://www.projectcalico.org/">Calico CNI</a></p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/installK8s4.png" data-background-size="contain">
            <p>Install Docker, kubelet</p>
            <p>Install kubeadm, kubectl on manager</p>
            <p>Install <a href="https://www.projectcalico.org/">Calico CNI</a></p>
            <p>Use kubeadm to stand up cluster</p>
            <p class="fragment"><a href="https://linode.com/docs/applications/containers/how-to-deploy-nginx-on-a-kubernetes-cluster/">Tutorial on Linode docs</a></p>
          </section>
          <section>
            <h2>Storage still tricky</h2>
            <p class="fragment">Traditionally-managed NFS</p>
            <p class="fragment"><a href="https://ceph.com/">Ceph</a>, <a href="https://rook.io/">Rook</a>, <a href="https://github.com/heketi/heketi">Heketi</a> have k8s integration</p>
            <!-- <p class="fragment">Alternative: <a href="https://www.drupal.org/project/s3fs">S3 File System</a>, <a href="https://www.drupal.org/project/flysystem_s3">FlySystem s3</a><span class="fragment">?</span></p> -->
          </section>
          <section data-transition="none">
            <img src="images/easierWay1.png" />
          </section>
          <section data-transition="none">
            <img src="images/easierWay2.png" />
          </section>
          <section data-transition="none">
            <img src="images/easierWay3.png" />
          </section>
          <section data-transition="none">
            <img src="images/easierWay4.png" />
          </section>
          <section>
            <h2>Managed kubernetes</h2>
            <p class="fragment">Like a VPS, but for k8s workloads</p>
            <p class="fragment">Pay only for workers, storage baked-in</p>
          </section>
          <section>
            <h2>Providers</h2>
            <p class="fragment">Amazon, Azure, DigitalOcean, Google GKE, others</p>
            <p class="fragment"><a href="https://kubernetes.io/docs/setup/pick-right-solution/">kubernetes.io/docs/setup/pick-right-solution</a></p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/bestChance1.png" data-background-size="contain">
            <h2>Digitalocean</h2>
            <p class="fragment">World-wide k8s provider</p>
            <p class="fragment">REST-based API</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/bestChance2.png" data-background-size="contain">
            <h2>Digitalocean</h2>
            <p class="">World-wide k8s provider</p>
            <p class="">REST-based API</p>
          </section>
        </section>

        <section>
          <section data-transition="none" data-background-transition="none" data-background="images/yamlAllArounYou.png" data-background-size="contain">
            <h1>The YAML is all around you</h1>
          </section>
          <section data-background-transition="none" data-background="images/architecture1.png" data-background-size="contain">
            <h2>Architecture</h2>
            <p class="fragment">Create 3-worker cluster of <code>s-1vcpu-2gb</code> nodes</p>
            <p class="fragment">Use <a href="https://github.com/ten7/flight-deck">TEN7's Flight Deck</a> for containers</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture4.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture5.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture6.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture7.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture8.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture9.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none">
            <pre><code>---
apiVersion: extensions/v1beta1  # k8s' API version for this doc.
kind: Deployment                # The object type.
metadata:
  name: web
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - image: ten7/flight-deck-web
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80
        - image: "ten7/flight-deck-varnish"
          imagePullPolicy: Always
          name: varnish
          ports:
            - containerPort: 6081</code></pre>
            <small>&nbsp;</small>
          </section>
          <section data-transition="none">
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: web    # The name of the deployment.
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - image: ten7/flight-deck-web
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80
        - image: "ten7/flight-deck-varnish"
          imagePullPolicy: Always
          name: varnish
          ports:
            - containerPort: 6081</code></pre>
            <small>&nbsp;</small>
          </section>
          <section data-transition="none">
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 3      # The number of replicas.
  template:
    metadata:
      labels:
        app: web   # A key/value pair used by the service.
    spec:
      containers:
        - image: ten7/flight-deck-web
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80
        - image: "ten7/flight-deck-varnish"
          imagePullPolicy: Always
          name: varnish
          ports:
            - containerPort: 6081</code></pre>
            <small>&nbsp;</small>
          </section>
          <section data-transition="none">
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - image: ten7/flight-deck-web        # The image to use.
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80
        - image: "ten7/flight-deck-varnish"  # The image to use.
          imagePullPolicy: Always
          name: varnish
          ports:
            - containerPort: 6081</code></pre>
            <small>&nbsp;</small>
          </section>
          <section data-transition="none">
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - image: ten7/flight-deck-web
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80             # Open port 80.
        - image: "ten7/flight-deck-varnish"
          imagePullPolicy: Always
          name: varnish
          ports:
            - containerPort: 6081           # Open port 6081.</code></pre>
            <small>(Scroll down.)</small>
          </section>
          <section>
            <pre><code>---
apiVersion: v1
kind: Service
metadata:
  name: web
spec:
  ports:
    - name: http
      port: 80
    - name: varnish
      port: 6081
  selector:
    app: web
  type: LoadBalancer</code></pre>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/wheresTheDB1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/wheresTheDB2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/wheresTheDB3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/wheresTheDB4.png" data-background-size="contain">
            <h2>Secrets</h2>
            <p class="fragment">Defined as a their own object</p>
            <p class="fragment">Mounted into the deployment as a disk</p>
          </section>
          <section>
            <pre><code>---
apiVersion: v1
kind: Secret
metadata:
  name: mysql
data:
  MYSQL_ROOT_PASSWORD: "YXZlcnliYWRwYXNzd29yZAo="   # These
  MYSQL_DATABASE: "ZHJ1cGFsX2Ri"                    # must be
  MYSQL_USER: "ZHJ1cGFs"                            # base64
  MYSQL_PASSWORD: "cGFzc3dvcmQ="                    # encoded.</code></pre>
          </section>
          <section>
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - image: ten7/flight-deck-web
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80
          volumeMounts:
            - name: vol-secrets-db       # Define where to mount
              mountPath: /secrets/mysql  # our DB credentials.
        - image: "ten7/flight-deck-varnish"
          imagePullPolicy: Always
          name: varnish
          ports:
            - containerPort: 6081
      volumes:
        - name: vol-secrets-db           # Create a "disk"
          secret:                        # for or mysql secret.
            secretName: mysql</code></pre>
            <small>(Scroll down.)</small>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture9.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture10.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture11.png" data-background-size="contain">
            &nbsp;
          </section>
          <section>
            <h2>Provisioning pvcs</h2>
            <p class="fragment">DigitalOcean, GKE, others: Single writer only!</p>
            <p class="fragment">Can't use for multiple web pods</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture12.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture13.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture14.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/fastestDisk1.png" data-background-size="contain">
            <h2>Static files</h2>
            <p class="fragment">...do <strong>not</strong> need block storage!</p>
            <p class="fragment">Object stores multi-writer by default</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/fastestDisk2.png" data-background-size="contain">
            <h2>Static files</h2>
            <p class="">...do <strong>not</strong> need block storage!</p>
            <p class="">Object stores multi-writer by default</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture15.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture16.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture17.png" data-background-size="contain">
            &nbsp;
          </section>
          <section>
            <h2>StatefulSets</h2>
            <p class="fragment">A special kind of Deployment</p>
            <p class="fragment">Hostname assigned deterministically</p>
          </section>
          <section>
            <pre><code>---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcache
spec:
  selector:
    matchLabels:
      app: memcache      # Must match the service selector!
  serviceName: memcache
  replicas: 3
  template:
    metadata:
      labels:
        app: memcache
    spec:
      containers:
        - image: "memcached:1.5-alpine"
          imagePullPolicy: Always
          name: "memcache"
          ports:
            - containerPort: 11211
              name: memcache
              protocol: TCP</code></pre>
              <small class="fragment">(Scroll down.)</small>
          </section>
          <section>
            <pre><code>---
apiVersion: v1
kind: Service
metadata:
  name: memcache
spec:
  clusterIP: None     # Turn off load balancing!
  ports:
    - name: memcache
      port: 11211
      protocol: TCP
  selector:
    app: memcache</code></pre>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture18.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture19.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture20.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture21.png" data-background-size="contain">
            &nbsp;
          </section>
          <section>
            <h2>ingress</h2>
            <p class="fragment">k8s-managed edge load balancer</p>
            <p class="fragment">Maps domains names to k8s Services</p>
            <p class="fragment">Can terminate SSL</p>
          </section>
          <section data-transition="none">
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: "my-cluster-ingress"
  annotations:
    ingress.kubernetes.io/app-root: /           # keep logged-in
    ingress.kubernetes.io/affinity: cookie      # users on the
    ingress.kubernetes.io/enable-cors: "true"   # same replica.
spec:
  tls:
    - hosts:
        - "example.com"
      secretName: ingress
  rules:
    - host: example.com
      http:
        paths:
          - path: /
            backend:
              serviceName: web
              servicePort: 6081</code></pre>
            <small>&nbsp;</small>
          </section>
          <section data-transition="none">
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: "my-cluster-ingress"
  annotations:
    ingress.kubernetes.io/app-root: /
    ingress.kubernetes.io/affinity: cookie
    ingress.kubernetes.io/enable-cors: "true"
spec:
  tls:
    - hosts:
        - "example.com"    # Use HTTPS for this domain name.
      secretName: ingress  # The cert chain is stored here.
  rules:
    - host: example.com
      http:
        paths:
          - path: /
            backend:
              serviceName: web
              servicePort: 6081</code></pre>
            <small>&nbsp;</small>
          </section>
          <section data-transition="none">
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: "my-cluster-ingress"
  annotations:
    ingress.kubernetes.io/app-root: /
    ingress.kubernetes.io/affinity: cookie
    ingress.kubernetes.io/enable-cors: "true"
spec:
  tls:
    - hosts:
        - "example.com"
      secretName: ingress
  rules:
    - host: example.com             # For this domain name...
      http:
        paths:
          - path: /                 # ...on this path...
            backend:
              serviceName: web      # ...map to this service...
              servicePort: 6081     # ...on this port.</code></pre>
            <small>(Scroll down.)</small>
          </section>
          <section>
            <h2>ingress tls secret</h2>
            <p class="fragment">Provides the combined cert chain...</p>
            <p class="fragment">...and the private key.</p>
          </section>
          <section>
            <pre><code>---
apiVersion: v1
data:
  tls.crt: "base64_encoded_cert_chain"
  tls.key: "base64_encoded_private_key"
kind: Secret
metadata:
  name: ingress
  namespace: default
type: Opaque</code></pre>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture21.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/architecture22.png" data-background-size="contain">
            &nbsp;
          </section>
        </section>

        <section>
          <section data-transition="none">
            <img src="images/gettingIntoDO1.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingIntoDO2.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingIntoDO3.png" />
          </section>
          <section data-background-transition="none" data-background="images/yavin.png" data-background-size="contain">
            <h1>The buildchain of yavin</h1>
          </section>
          <section>
            <h2>Deploying YAML</h2>
            <p class="fragment"><code>kubectl apply -f path/to/my_object.yml</code></p>
            <p class="fragment">Repeat for each YAML file to deploy</p>
          </section>
          <section data-transition="none">
            <img src="images/removeHumans1.png" />
          </section>
          <section data-transition="none">
            <img src="images/removeHumans2.png" />
          </section>
          <section data-transition="none">
            <img src="images/removeHumans3.png" />
          </section>
          <section>
            <h2>Repeatable Clusters</h2>
            <p class="fragment">Clients only differ in sizes, logins, some features</p>
            <p class="fragment">Use Ansible vars & templates to generate YAML</p>
          </section>
          <section data-transition="none">
            <img src="images/buildchain1.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain2.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain3.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain4.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain5.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain6.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain7.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain8.png" />
          </section>
          <section>
            <h2>Authentication</h2>
            <p class="fragment">Create a <a href="https://www.digitalocean.com/docs/api/create-personal-access-token/">Personal Access Token</a></p>
            <p class="fragment">Passed to DigitalOcean API as HTTP header</p>
          </section>
          <section>
            <h2>Creating the cluster</h2>
            <p class="fragment"><a href="https://galaxy.ansible.com/socketwench/digitalocean"><code>socketwench.digitalocean</code></a> role on Ansible Galaxy</p>
            <p class="fragment">Handles scaling, node pools, adds ingress controller</p>
          </section>
          <section>
            <pre><code>---
- hosts: all
  vars:
    digitalocean_api_token: "abcde1234567890"
    digitalocean_clusters:
      - name: "my_k8s_cluser"
        region: "sfo2"
        node_pools:
          - size: "s-1vcpu-2gb"
            count: 3
            name: "web-pool"
            labels:
              - key: "app"
                value: "web"
          - size: "s-1vcpu-2gb"
            count: 1
            name: "db-pool"
            labels:
              - key: "app"
                value: "database"
  roles:
    - socketwench.digitalocean</code></pre>
            <small class="fragment">(Scroll down.)</small>
          </section>
          <section>
            <h2>Authorizing kubectl</h2>
            <p class="fragment"><a href="https://galaxy.ansible.com/socketwench/digitalocean_kubeconfig"><code>socketwench.digitalocean_kubeconfig</code></a> role</p>
            <p class="fragment">Gets the auth file from DO API</p>
          </section>
          <section>
            <pre><code>    - name: Get the kubeconfig file.
      import_role:
        name: socketwench.digitalocean_kubeconfig
      vars:
        digitalocean_kubeconfig:
          cluster: "my_k8s_cluser"
          kubeconfig: "/path/to/my/kubeconfig.yaml"</code></pre>
          </section>
          <section>
            <h2>Writing the k8s yaml</h2>
            <p class="fragment">Ansible <a href="https://docs.ansible.com/ansible/latest/modules/template_module.html"><code>Template</code></a> module</p>
            <p class="fragment">Replaces placeholders in k8s files with values</p>
          </section>
          <section>
            <pre><code>---
apiVersion: v1
data:
  tls.crt: "{{ ingress_tls_cert | b64encode }}"
  tls.key: "{{ ingress_tls_key | b64encode }}"
kind: Secret
metadata:
  name: ingress
type: Opaque</code></pre>
          </section>
          <section>
            <h2>Deploying containers</h2>
            <p class="fragment">Ansible <a href="https://docs.ansible.com/ansible/latest/modules/k8s_module.html"><code>k8s</code></a> module</p>
            <p class="fragment">Pass auth file as <code>kubeconfig</code> param</p>
            <p class="fragment">Loop over all templated files, applying config</p>
          </section>
          <section>
            <h2>Multi-tenancy</h2>
            <p class="fragment">One site = one namespace</p>
            <p class="fragment">Allows consistent deployment, service names</p>
          </section>
          <section>
            <pre><code>    - name: Apply the definitions
      k8s:
        state: present
        namespace: "example-com"                    # Avoid dots!
        kubeconfig: "/path/to/my/kubeconfig.yaml"
        src: "{{ item }}"
      loop: "{{ k8s_yaml_files }}"</code></pre>
          </section>
        </section>

        <section>
          <section data-transition="none">
            <img src="images/deployingSites1.png" />
          </section>
          <section data-transition="none">
            <img src="images/deployingSites2.png" />
          </section>
          <section data-transition="none">
            <img src="images/deployingSites3.png" />
          </section>
          <section data-transition="none">
            <img src="images/deployingSites4.png" />
          </section>
          <section data-transition="none">
            <img src="images/deployingSites5.png" />
          </section>
          <section data-transition="none">
            <img src="images/deployingSites6.png" />
          </section>
          <section data-transition="" data-background-transition="none" data-background="images/deployThisThing1.png" data-background-size="contain">
            <h1>You're all clear, k8s!</h1>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/deployThisThing2.png" data-background-size="contain">
            <h1>You're all clear, k8s!</h1>
          </section>
          <section data-background-transition="none" data-background="images/notHowTheK8sWorks1.png" data-background-size="contain">
            <h2>updating in place</h2>
            <p class="fragment">Used for shared hosting, VPSes</p>
            <p class="fragment">SFTP, git deploy, some CI systems</p>
          </section>
          <section data-background-transition="none" data-background="images/notHowTheK8sWorks2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/notHowTheK8sWorks3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/notHowTheK8sWorks4.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/notHowTheK8sWorks5.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/notHowTheK8sWorks6.png" data-background-size="contain">
            <h2>the site is the app</h2>
            <p class="fragment">It should <strong>be</strong> the container!</p>
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild1.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild2.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild3.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild4.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild5.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild6.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild7.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild8.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sBuild9.png" />
          </section>
          <!-- <section>
            <h2>images as artifacts</h2>
            <p class="fragment">Older versions retained in registry</p>
            <p class="fragment">Easier roll-back, troubleshooting</p>
          </section> -->
          <section>
            <h2>private registry</h2>
            <p class="fragment">Stores built, site-specific images</p>
            <p class="fragment">k8s needs auth token pass in Secrets</p>
            <p class="fragment"><a href="https://docs.docker.com/registry/deploying/">Tutorial on docs.docker.com</a></p>
          </section>
          <section>
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: web
    spec:
      imagePullSecrets:
        - name: my-registry-key  # Needed to auth with registry
      containers:
        # Site-specific image, with tags as version
        - image: myRegistry.tld:5000/example.com:1.0.7
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80
        - image: "ten7/flight-deck-varnish"
          imagePullPolicy: Always
          name: varnish
          ports:
            - containerPort: 6081</code></pre>
              <small class="fragment">(Scroll down.)</small>
          </section>
          <section data-background-transition="none" data-background="images/butHowDoWeUpdate1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/butHowDoWeUpdate2.png" data-background-size="contain">
            <h2>rolling update</h2>
            <p class="fragment">Replaces running containers with new image</p>
            <p class="fragment">Performed sequentially, reduces outages</p>
          </section>
          <section>
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 3
  strategy:
    type: RollingUpdate   # Use Rolling updates
    rollingUpdate:
      maxSurge: 1         # Allow 3 replicas during update
      maxUnavailable: 1   # Only update 1 at a time
  minReadySeconds: 5      # Wait 5s before updating the next
  template:
    metadata:
      labels:
        app: web
    spec:
      imagePullSecrets:
        - name: my-registry-key
      containers:
        - image: myRegistry.tld:5000/example.com:1.0.7
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80
        - image: "ten7/flight-deck-varnish"
          imagePullPolicy: Always
          name: varnish
          ports:
            - containerPort: 6081</code></pre>
            <small class="fragment">(Scroll down.)</small>
          </section>
        </section>

        <section>
          <section>
            <h2>Further reading</h2>
            <p class="fragment"><a href="http://kubernetesbyexample.com/">kubernetesbyexample.com</a></p>
            <p class="fragment"><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">Interactive tutorial on kubernetes.io</a></p>
            <p class="fragment"><a href="https://developers.digitalocean.com/documentation/v2/">DigitalOcean API Docs</a></p>
          </section>
        </section>

        <section>
          <section>
            <h2>Special thanks</h2>
            <p class="fragment">Drupaldelphia</p>
            <p class="fragment"><a href="https://ten7.com/">TEN7</a></p>
            <p class="fragment"><a href="https://www.patreon.com/socketwench">patreon.com/socketwench</a></p>
          </section>

          <section data-background-transition="fade" data-background="images/thereIsAnother1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="fade" data-background="images/thereIsAnother2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/thereIsAnother3.png" data-background-size="contain">
            <h2>Free stuff!</h2>
            <p class="fragment">$100 credit on DigitalOcean</p>
            <p class="fragment"><a href="https://ten7.com/digitalocean"><code>ten7.com/digitalocean</code></a></p>
          </section>

          <section data-background-transition="none" data-background="images/thankYou.png" data-background-size="contain">
            <h1>Thank you!</h1>
            <p>socketwench.github.io/return-of-the-clustering</p>
            <p>&nbsp;</p>
          </section>
        </section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			Reveal.initialize({
        history: true,
        controls: false,
        progress: true,
        center: true,
        width: 1024,
        height: 763,
        transition: 'slide',

				dependencies: [
				  { src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
