<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Return of the Clustering</title>

		<link rel="stylesheet" href="css/reveal.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
    <link rel="stylesheet" href="css/theme/long-ago-faraway.css">

	</head>
	<body>
		<div class="reveal">
			<div class="slides">
        <section>
          <h1>Return <small>of the</small> Clustering</h1>
          <p>&nbsp;</p>
          <p>use &larr;&uarr;&darr;&rarr; or &lt;space&gt;</p>
        </section>

        <section>
          <h2>"Where's the links?"</h2>
          <p><a href="https://socketwench.github.io/reurn-of-the-clustering/#/">socketwench.github.io/reurn-of-the-clustering</a></p>
        </section>

        <section>
          <section data-transition="none" data-background-transition="none" data-background="images/socketwench1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/socketwench2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/socketwench3.png" data-background-size="contain">
            &nbsp;
          </section>
					<section data-transition="none" data-background-transition="none" data-background="images/socketwench4.png" data-background-size="contain">
            &nbsp;
          </section>
					<section data-transition="none" data-background-transition="none" data-background="images/socketwench5.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background="images/t7-background.jpg" class="teamten7">
            <img src="images/TEN7-logo.png" />
            <p>We create and care for<br />Drupal-powered websites.</p>
            <p><a href="https://twitter.com/TEN7">@TEN7</a><br /><a href="mailto:hi@ten7.com">hi@ten7.com</a></p>
          </section>

          <section  data-transition="none" data-background-transition="none" data-background="images/trilogy1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/trilogy2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/trilogy3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/trilogy4.png" data-background-size="contain">
            <a href="https://www.youtube.com/watch?v=mQSQH8tT9bA">
              <h2>Ride the Whale</h2>
              <p>Docker for Drupalists</p>
            </a>
            <a href="https://www.youtube.com/watch?v=2K4B48hrYfE" class="fragment">
              <h2>Avoid Deep Hurting!</h2>
              <p>Deployments beyond git</p>
            </a>
          </section>
        </section>

        <section>
          <section>
            <h1>Huggable servers</h1>
          </section>
          <section data-transition="none">
            <img src="images/huggableServers1.png" />
          </section>
          <section data-transition="none">
            <img src="images/huggableServers2.png" />
          </section>
          <section data-transition="none">
            <img src="images/huggableServers3.png" />
          </section>
          <section data-transition="none">
            <img src="images/huggableServers4.png" />
          </section>
          <section data-transition="none">
            <img src="images/huggableServers5.png" />
          </section>
          <section data-transition="none">
            <img src="images/huggableServers6.png" />
          </section>
          <section data-transition="none">
            <img src="images/huggableServers7.png" />
          </section>
          <section data-transition="none">
            <img src="images/huggableServers8.png" />
          </section>
          <section>
            <h2>Per-client stacks</h2>
            <p class="fragment">Isolation between clients</p>
            <p class="fragment">Allow different services, versions</p>
          </section>
          <section>
            <h2>Repeatability</h2>
            <p class="fragment">Must be stood-up quickly</p>
            <p class="fragment">Repeatable from template</p>
          </section>
          <section>
            <h2>Reduce costs</h2>
            <p class="fragment">Existing cluster expensive</p>
          </section>
          <section>
            <h2>Less "huggable"</h2>
            <p class="fragment">Configured only using automation</p>
            <p class="fragment">Avoid direct changes via human-hands!</p>
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable1.png" />
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable2.png" />
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable3.png" />
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable4.png" />
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable5.png" />
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable6.png" />
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable7.png" />
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable8.png" />
          </section>
          <section data-transition="none">
            <img src="images/lessHuggable9.png" />
          </section>
          <section>
            <h2>Manual steps</h2>
            <p class="fragment">Creation of servers on VPS</p>
            <p class="fragment">Adding admin user, SSH key, initial utils</p>
          </section>
          <section data-transition="none">
            <img src="images/soMuchTime1.png" />
          </section>
          <section data-transition="none">
            <img src="images/soMuchTime2.png" />
          </section>
          <section data-transition="none">
            <img src="images/soMuchTime3.png" />
          </section>
          <section>
            <h2>What's missing?</h2>
            <p class="fragment">API integration with VPS</p>
            <p class="fragment">Was under development at the time</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/notTheSame1.png" data-background-size="contain">
            <h2>Did it match dev?</h2>
            <p class="fragment">Well...<span class="fragment">mostly.</span></p>
            <p class="fragment">Versions and config as close as possible</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/notTheSame2.png" data-background-size="contain">
            <h2>Did it match dev?</h2>
            <p class="">Well...<span class="">mostly.</span></p>
            <p class="">Versions and config as close as possible</p>
          </section>
        </section>

        <section>
          <section data-transition="none">
            <img src="images/dockerInProd1.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd2.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd3.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd4.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd5.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd6.png" />
          </section>
          <section data-transition="none">
            <img src="images/dockerInProd7.png" />
          </section>
          <section>
            <h1>Docker in Production?</h1>
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard4.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard5.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard6.png" data-background-size="contain">
            &nbsp;
          </section>
          <section  data-transition="none" data-background-transition="none" data-background="images/itCantBeThatHard7.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/dockersecurity1.png" data-background-size="contain">
            <h2>Docker Security</h2>
            <p class="fragment">Docker maps users between host and container</p>
            <p class="fragment">Most containers run...<span class="fragment">as root</span></p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/dockersecurity2.png" data-background-size="contain">
            <h2>Docker Security</h2>
            <p>Docker maps users between host and container</p>
            <p>Most containers run...<span>as root</span></p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/dockersecurity3.png" data-background-size="contain">
            <h2>Docker Security</h2>
            <p>Docker maps users between host and container</p>
            <p>Most containers run...<span>as root</span></p>
          </section>
          <section>
            <h2>Passing config</h2>
            <p class="fragment">Avoid Compose-style environment variables</p>
            <p class="fragment">Use <a href="https://docs.docker.com/engine/swarm/secrets/">Secrets</a> instead</p>
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts01.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts02.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts03.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts04.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts05.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts06.png" />
          </section>
          <section data-transition="none">
            <img src="images/multipledockerhosts07.png" />
          </section>
          <section>
            <h2>Single-node Docker</h2>
            <p class="fragment">Runs all containers on the same system</p>
            <p class="fragment">Easy, but scaling is vertical only</p>
          </section>
          <section>
            <h2>orchestration</h2>
            <p class="fragment">Coordinates hosts to act as one</p>
            <p class="fragment">Deploy instances, distribute load, deliver resources</p>
          </section>
          <section>
            <h2>Swarm mode</h2>
            <p class="fragment">Docker's own orchestrator</p>
            <p class="fragment">Built-in, free to use</p>
          </section>
          <section data-transition="none">
            <img src="images/swarm01.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm02.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm03.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm04.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm05.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm06.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm07.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm08.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm09.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm10.png" />
          </section>
          <section data-transition="none">
            <img src="images/swarm11.png" />
          </section>
          <section>
            <h2>Lack of hosting choice</h2>
            <p class="fragment">Docker cloud was expensive <span class="fragment">(and discontinued)</span></p>
            <p class="fragment">Self-host, sort out LB and storage</p>
          </section>
          <section>
            <h2>Too "uncontrolled"</h2>
            <p class="fragment">Containers only managable unit</p>
            <p class="fragment">Internal LB creates Drupal problems</a>
          </section>
        </section>
        <section>
          <section data-transition="none">
            <img src="images/whatsThis1.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThis2.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThis3.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThis4.png" />
          </section>
          <section data-transition="none">
            <img src="images/whatsThis5.png" />
          </section>
          <section>
            <h1>Koo-ber-WHAT-ees?</h1>
          </section>
          <section>
            <h2>Kubernetes</h2>
            <p class="fragment">Open-source container orchestrator</p>
            <p class="fragment">Created by Google</a>
          </section>
          <section>
            <h2>Expressive Power</h2>
            <p class="fragment"><em>Pods</em> only one of many managable objects</p>
            <p class="fragment">Tailor k8s to your app, not the other way around</p>
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical1.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical2.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical3.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical4.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical5.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical6.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical7.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical8.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sPhysical9.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical1.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical2.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical3.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical4.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical5.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical6.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical7.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical8.png" />
          </section>
          <section data-transition="none">
            <img src="images/k8sLogical9.png" />
          </section>
          <section>
            <h2>Deployments</h2>
            <p class="fragment">Describes an application</p>
            <p class="fragment">Not just what containers to use</p>
            <p class="fragment">Replicas, health checks, placement</p>
          </section>
          <section>
            <h2>Services</h2>
            <p class="fragment">A consistent application endpoint</p>
            <p class="fragment">Internal, external, load-balanced</p>
          </section>
          <section>
            <h2>volume Claim</h2>
            <p class="fragment">A request for persistent storage</p>
            <p class="fragment">How much, from where, sharability</p>
          </section>
          <section>
            <h2>Deploying objects</h2>
            <p class="fragment">Declaritive YAML pushed to manager</p>
            <p class="fragment">YAML can be patched, diffed, even replaced</p>
          </section>
          <section data-transition="none" data-background-transition="fade" data-background="images/this-much-devops.jpg" data-background-size="contain">
            &nbsp;
          </section>
        </section>

        <section>
          <section data-transition="none">
            <img src="images/hosting1.png" />
          </section>
          <section data-transition="none">
            <img src="images/hosting2.png" />
          </section>
          <section data-transition="none">
            <img src="images/hosting3.png" />
          </section>
          <section data-transition="none">
            <img src="images/hosting4.png" />
          </section>
          <section data-background="images/speeder.png" data-background-size="contain">
            <h1>Getting to Kube-y station</h1>
          </section>
          <section>
            <h2>Self-host</h2>
            <p class="fragment">Internal on existing hardware...</p>
            <p class="fragment">...or 3rd-party VPS service</p>
          </section>
          <section>
            <h2>Less lock-in</h2>
            <p class="fragment">No reliance on special APIs</p>
            <p class="fragment">Requires staff to manage cluster, set up storage</p>
          </section>
          <section>
            <h2>Privacy</h2>
            <p class="fragment">Country-local, legal requirements</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/installK8s1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/installK8s2.png" data-background-size="contain">
            <p>Install Docker, kubelet</p>
            <p class="fragment">Install kubeadm, kubectl on manager</p>
            <p class="fragment">Install <a href="https://www.projectcalico.org/">Calico CNI</a></p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/installK8s3.png" data-background-size="contain">
            <p>Install Docker, kubelet</p>
            <p>Install kubeadm, kubectl on manager</p>
            <p>Install <a href="https://www.projectcalico.org/">Calico CNI</a></p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
          </section>
          <section style="text-align: left;" data-transition="none" data-background-transition="none" data-background="images/installK8s4.png" data-background-size="contain">
            <p>Install Docker, kubelet</p>
            <p>Install kubeadm, kubectl on manager</p>
            <p>Install <a href="https://www.projectcalico.org/">Calico CNI</a></p>
            <p>Use kubeadm to stand up cluster</p>
            <p class="fragment"><a href="https://linode.com/docs/applications/containers/how-to-deploy-nginx-on-a-kubernetes-cluster/">Tutorial on Linode docs</a></p>
          </section>
          <section>
            <h2>Storage still tricky</h2>
            <p class="fragment">Traditionally-managed NFS</p>
            <p class="fragment"><a href="https://ceph.com/">Ceph</a>, <a href="https://rook.io/">Rook</a>, <a href="https://github.com/heketi/heketi">Heketi</a> have k8s integration</p>
            <p class="fragment">Alternative: <a href="https://www.drupal.org/project/s3fs">S3 File System</a><span class="fragment">?</span></p>
          </section>
          <section data-transition="none">
            <img src="images/easierWay1.png" />
          </section>
          <section data-transition="none">
            <img src="images/easierWay2.png" />
          </section>
          <section data-transition="none">
            <img src="images/easierWay3.png" />
          </section>
          <section data-transition="none">
            <img src="images/easierWay4.png" />
          </section>
          <section>
            <h2>Managed kubernetes</h2>
            <p class="fragment">Like a VPS, but for k8s workloads</p>
            <p class="fragment">Pay only for workers, storage baked-in</p>
          </section>
          <section>
            <h2>Providers</h2>
            <p class="fragment">Amazon, Google GKE, Azure, Digital Ocean, others</p>
            <p class="fragment"><a href="https://kubernetes.io/docs/setup/pick-right-solution/">kubernetes.io/docs/setup/pick-right-solution</a></p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/bestChance1.png" data-background-size="contain">
            <h2>GKE</h2>
            <p class="fragment">"The standard" in managed k8s</p>
            <p class="fragment">Integrates with Compute Engine, strong API support</p>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/bestChance2.png" data-background-size="contain">
            <h2>GKE</h2>
            <p class="">"The standard" in managed k8s</p>
            <p class="">Integrates with Compute Engine, strong API support</p>
          </section>
        </section>

        <section>
          <section data-transition="none" data-background-transition="none" data-background="images/yamlAllArounYou.png" data-background-size="contain">
            <h1>The YAML is all around you</h1>
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/kindaWordy1.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/kindaWordy2.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/kindaWordy3.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/kindaWordy4.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-transition="none" data-background-transition="none" data-background="images/kindaWordy5.png" data-background-size="contain">
            &nbsp;
          </section>
          <section data-background-transition="none" data-background="images/kindaWordy6.png" data-background-size="contain">
            <h2>Helpful Tutorials</h2>
            <p class="fragment"><a href="http://kubernetesbyexample.com/">kubernetesbyexample.com</a></p>
            <p class="fragment"><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">kubernetes.io/docs/tutorials/kubernetes-basics</a></p>
          </section>
          <section>
            <h2>Architecture</h2>
            <p class="fragment">Use <a href="https://github.com/ten7/flight-deck">TEN7's Flight Deck</a> for containers</p>
            <p class="fragment">Create 3-worker cluster of <code>g1-small</code> nodes</p>
          </section>
          <section>
            <h2>Storage</h2>
            <p class="fragment">Host Drupal code, file uploads, MySQL</p>
            <p class="fragment">Needs multi-writer, multi-reader support</p>
          </section>
          <section>
            <h2>Access modes</h2>
            <p class="fragment">Specified on the Persistent Volume Claim (PVC)</p>
            <p class="fragment"><code>ReadWriteOnce</code> = only one node may read & write</p>
            <p class="fragment"><code>ReadWriteMany</code> = many readers and writers</p>
          </section>
          <section data-transition="none">
            <img src="images/architecture1.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture2.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture3.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture4.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture5.png" />
          </section>
          <!-- <section data-transition="none">
            <img src="images/architecture5.5.png" />
          </section> -->
          <section data-transition="none">
            <img src="images/architecture6.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture7.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture8.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture9.png" />
          </section>
          <section>
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    app: web
  name: web
spec:
  replicas: 2
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - image: ten7/flight-deck-web
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80</code></pre>
            <small class="fragment">(Scroll down.)</small>
          </section>
          <section>
            <pre><code>---
apiVersion: v1
kind: Service
metadata:
  name: web
spec:
  ports:
    -
      name: http
      port: 80
      protocol: TCP
  selector:
    app: web
  type: LoadBalancer</code></pre>
          </section>
          <section data-transition="none">
            <img src="images/architecture9.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture10.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture11.png" />
          </section>
          <section>
            <h2>GKE provisioned disks</h2>
            <p class="fragment">Single writer only!</p>
            <p class="fragment">Can't use for multiple Apache pods</p>
          </section>
          <section data-transition="none">
            <img src="images/architecture12.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture13.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture14.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture15.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture16.png" />
          </section>
          <section>
            <h2>persistentvolume</h2>
            <p class="fragment">Makes existing disk known to k8s</p>
            <p class="fragment">Can have PVCs claim <em>against</em> it</p>
          </section>
          <section>
            <pre><code>---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs
spec:
  capacity:
    storage: 30Gi
  accessModes:
    - ReadWriteMany
  nfs:
    # $(service name).$(namespace).svc.cluster.local
    server: nfs-server.default.svc.cluster.local
    path: "/"</code></pre>
          </section>
          <section>
            <pre><code>---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: nfs
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: ""
  resources:
    requests:
      storage: 30Gi</code></pre>
          </section>
          <section>
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    app: web
  name: web
spec:
  replicas: 2
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - image: ten7/flight-deck-web
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 80
          volumeMounts:
            - mountPath: /var/www/html
              name: vol-drupal
              subPath: html
      volumes:
        - name: vol-drupal
          persistentVolumeClaim:
            claimName: nfs</code></pre>
            <small class="fragment">(Scroll down.)</small>
          </section>
          <section data-transition="none">
            <img src="images/architecture17.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture18.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture19.png" />
          </section>
          <section>
            <h2>StatefulSets</h2>
            <p class="fragment">A special kind of Deployment</p>
            <p class="fragment">Hostname assigned deterministically</p>
          </section>
          <section>
            <pre><code>---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: memcache
spec:
  selector:
    matchLabels:
      app: memcache
  serviceName: memcache
  replicas: 3
  template:
    metadata:
      labels:
        app: memcache
    spec:
      nodeSelector:
        tier: workload
      containers:
        - image: "memcached:1.5-alpine"
          imagePullPolicy: Always
          name: "memcache"
          ports:
            - containerPort: 11211
              name: memcache
              protocol: TCP</code></pre>
              <small class="fragment">(Scroll down.)</small>
          </section>
          <section>
            <pre><code>---
apiVersion: v1
kind: Service
metadata:
  name: memcache
spec:
  # Turn off load balancing!
  clusterIP: None
  ports:
    - name: memcache
      port: 11211
      protocol: TCP
  selector:
    app: memcache</code></pre>
          </section>
          <section data-transition="none">
            <img src="images/architecture20.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture21.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture22.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture23.png" />
          </section>
          <section>
            <h2>ingress</h2>
            <p class="fragment">k8s-provided edge load balancer</p>
            <p class="fragment">Maps domains names to k8s Services</p>
            <p class="fragment">Can terminate SSL</p>
          </section>
          <section>
            <pre><code>---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: "my-cluster-ingress"
  annotations:
    ingress.kubernetes.io/app-root: /
    ingress.kubernetes.io/affinity: cookie
    ingress.kubernetes.io/enable-cors: "true"
spec:
  tls:
    - hosts:
        - "example.com"
      secretName: ingress
  backend:
    serviceName: varnish
    servicePort: 6081
  rules:
    - host: example.com
      http:
        paths:
          - path: /*
            backend:
              serviceName: varnish
              servicePort: 6081</code></pre>
            <small class="fragment">(Scroll down.)</small>
          </section>
          <section data-transition="none">
            <img src="images/architecture23.png" />
          </section>
          <section data-transition="none">
            <img src="images/architecture24.png" />
          </section>
        </section>

        <section>
          <section data-transition="none">
            <img src="images/gettingIntoGke1.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingIntoGke2.png" />
          </section>
          <section data-transition="none">
            <img src="images/gettingIntoGke3.png" />
          </section>
          <section data-background-transition="none" data-background="images/yavin.png" data-background-size="contain">
            <h1>The buildchain of yavin</h1>
          </section>
          <section>
            <h2>Deploying YAML</h2>
            <p class="fragment"><code>kubectl apply -f path/to/my_object.yml</code></p>
            <p class="fragment">Repeat for each YAML file to deploy</p>
          </section>
          <section data-transition="none">
            <img src="images/removeHumans1.png" />
          </section>
          <section data-transition="none">
            <img src="images/removeHumans2.png" />
          </section>
          <section data-transition="none">
            <img src="images/removeHumans3.png" />
          </section>
          <section>
            <h2>Repeatable Clusters</h2>
            <p class="fragment">Clients only differ in sizes, logins, some features</p>
            <p class="fragment">Use Ansible vars & templates to generate YAML</p>
          </section>
          <section data-transition="none">
            <img src="images/buildchain1.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain2.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain3.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain4.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain5.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain6.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain7.png" />
          </section>
          <section data-transition="none">
            <img src="images/buildchain8.png" />
          </section>
          <section>
            <h2>Authentication</h2>
            <p class="fragment"><code>gcloud auth login</code></p>
            <p class="fragment">Login persistent across shell sessions</p>
          </section>
          <section>
            <h2>Service account</h2>
            <p class="fragment">Proxy user for scripts, automation</p>
            <p class="fragment">Does <strong>not</strong> use your Google password</p>
            <p class="fragment"><a href="https://cloud.google.com/compute/docs/access/service-accounts">cloud.google.com/compute/docs/access/service-accounts</a></p>
          </section>
          <section>
            <pre><code>---
- hosts: kubectl
  tasks:
    - name: Deploy the gcloud key
      template:
        src: "templates/gcloud/service-account-key.json.j2"
        dest: "{{ _gcloud_auth_key_path }}"
    - name: Authorize the service account
      shell: >
        gcloud auth activate-service-account
        {{ _gcloud_service_account }}
        --key-file={{ gcloud_auth_key_path }}</code></pre>
          </section>
          <section>
            <h2>Creating the disk</h2>
            <p class="fragment">Ansible <code>gce_pd</code> module</p>
            <p class="fragment">Only creates once for the given name, project, zone</p>
          </section>
          <section>
            <pre><code>    - name: Provision the NFS persistent disk
      gce_pd:
        name: "{{ nfs_volume_name }}"
        size_gb: "{{ nfs_volume_size }}"
        project_id: "{{ gcloud_project_id }}"
        zone: "{{ gcloud_project_zone }}"
        credentials_file: "{{ _gcloud_auth_key_path }}"
        service_account_email: "{{ gcloud_service_account }}"
        disk_type: "pd-ssd"
        state: present</code></pre>
          </section>
          <section>
            <h2>Creating the cluster</h2>
            <p class="fragment">Ansible <code>gcp_container_cluster</code> module</p>
            <p class="fragment">Allocates worker nodes all in one command!</p>
          </section>
          <section>
            <pre><code>    - name: create a cluster
      gcp_container_cluster:
        name: "{{ gke_cluster_name }}"
        initial_node_count: "{{ gke_cluster_size_min | default(3) }}"
        node_config:
          machine_type: "g1-small"
          disk_size_gb: 100
        zone: "{{ gcloud_project_zone }}"
        project: "{{ gcloud_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ _gcloud_auth_key_path }}"
        scopes:
          - "https://www.googleapis.com/auth/cloud-platform"
        state: present</code></pre>
          </section>
          <section>
            <h2>Authorizing kubectl</h2>
            <p class="fragment">Use gcloud API to get k8s auth token</p>
            <p class="fragment">Necessary for deploying containers</p>
          </section>
          <section>
            <pre><code>    - name: Set the current cluster
      shell: >
        gcloud --quiet config set container/cluster
        {{ gke_cluster_name }}
    - name: Get the cluster credentials
      shell: >
        gcloud container clusters get-credentials
        {{ gke_cluster_name }}</code></pre>
          </section>
          <section>
            <h2>Writing the k8s yaml</h2>
            <p class="fragment">Combine per-object YAML using <code>Assemble</code></p>
            <p class="fragment">Use <code>Template</code> to write variables</p>
          </section>
          <section>
            <h2>Deploying containers</h2>
            <p class="fragment">Ansible <code>k8s</code> module</p>
            <p class="fragment">Loop over all templated files, applying config</p>
          </section>
          <section>
            <pre><code>    - name: Apply the definitions
      k8s:
        state: present
        namespace: "{{ item.namespace | default('default') }}"
        src: "{{ item.filename }}"
      loop: "{{ k8s_yaml_files }}"
      environment:
        GOOGLE_APPLICATION_CREDENTIALS: "{{ _gcloud_auth_key_path }}"</code></pre>
          </section>
        </section>

        <section>
          <section>
            <h1>You're all clear, k8s!</h1>
            <!--
            Now let's deploy this thing and go home!
            -->
          </section>
        </section>

        <section>
          <section>
            <h2>Special thanks</h2>
            <p class="fragment">Drupalcamp Florida</p>
            <p class="fragment"><a href="https://ten7.com/">TEN7</a></p>
            <p class="fragment"><a href="https://www.patreon.com/socketwench">patreon.com/socketwench</a></p>
          </section>

          <section data-background-transition="none" data-background="images/thankYou.png" data-background-size="contain">
            <h1>Thank you!</h1>
            <p>socketwench.github.io/return-of-the-clustering</p>
            <p>&nbsp;</p>
          </section>
        </section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			Reveal.initialize({
        history: true,
        controls: false,
        progress: true,
        center: true,
        width: 1024,
        height: 763,
        transition: 'slide',

				dependencies: [
				  { src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
